<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COVID-19患者積極的疫学調査シミュレータ</title>
    <link rel="icon" href="data:,">
    <!--
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2"></script>
    -->
    <script src="lib/vue/vue.global.js"></script>
    <link href="lib/vuetify/vuetify.min.css" rel="stylesheet">
    <script src="lib/vuetify/vuetify.min.js"></script>

    <!-- Material Design Icons -->
    <!--
    <link href="http://cdn.materialdesignicons.com/5.4.55/css/materialdesignicons.min.css" rel="stylesheet">
    -->
    <link href="lib/MaterialDesign/materialdesignicons.min.css" rel="stylesheet">

    <!--
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    -->
    <style>
        * {
            box-sizing: border-box;
        }
        html::-webkit-scrollbar,
        body::-webkit-scrollbar {
            display: none;
        }
        html, body {
            overflow-y: scroll;
        }
        .v-application {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .v-main {
            flex: 1 1 auto;
            overflow: scroll;
            display: flex;
            flex-direction: column;
        }
        .v-container {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
        }
        .v-row {
            flex: 1 1 auto;
        }
        .v-row.fill-height {
            height: 100%;
        }
        .chat-col {
            height: 100%;
            max-height: calc(100%);
        }
        #chat-card {
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
        }
        #chat-history-container {
            flex: 1 1 auto;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .message-bubble-user {
            background-color: #2563eb !important;
            color: white;
        }
        .message-bubble-patient {
            background-color: #f3f4f6 !important;
            color: #1f2937;
            border: 1px solid #e5e7eb;
        }
        #submitEndOfSession.v-list-item--variant-outlined {
            border: 2px solid #ff0000 !important;
        }
        @media print {
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .v-footer, .v-navigation-drawer, .v-card-title .v-btn, .v-expansion-panel-title {
                display: none !important;
            }
            .v-application, .v-main, .v-container, #chat-card, #chat-history-container {
                height: auto !important;
                overflow: visible !important;
            }
            .v-card {
                box-shadow: none !important;
                border: 1px solid #ddd;
            }
            .v-toolbar {
                display: none !important;
            }
            .message-bubble-user {
                background-color: #e0e0e0 !important;
                color: black !important;
            }
            .message-bubble-patient {
                background-color: #fafafa !important;
                color: black !important;
                border: 1px solid #e0e0e0;
            }
        }
    </style>
</head>

<body>
<div id="app">
    <v-app>
        <v-main>
            <v-container fluid class="pa-md-4 pa-2 d-flex flex-column">
                <!-- ヘッダー -->
                <v-card class="mb-4 pb-2 flex-shrink-0" rounded="lg" elevation="2">
                    <v-card-title class="d-flex align-center text-h6 text-md-h5 font-weight-bold text-blue-darken-4" style="word-break: keep-all; white-space: wrap;">
                        <v-icon start color="blue-darken-2">mdi-file-document-outline</v-icon>
                        <div>
                            <div style="display: inline-block;">COVID-19患者積極的</div>
                            <div style="display: inline-block;">疫学調査シミュレータ</div>
                        </div>
                        <v-spacer></v-spacer>
                        <v-btn icon="mdi-menu" @click.stop="drawer = !drawer"></v-btn>
                    </v-card-title>
                    <v-card-subtitle>
                        <v-chip v-if="MessageToUser" small :color="statusColor">{{ MessageToUser }}</v-chip>
                    </v-card-subtitle>
                </v-card>

                <!-- 患者情報パネル -->
                <div class="d-flex flex-column" style="height: auto;">
                    <v-expansion-panels v-if="patientInfo.id && roleNameDraft === '保健師'" style="flex: 1 1 auto; overflow-y: visible;">
                        <v-expansion-panel elevation="2" rounded="lg">
                            <v-expansion-panel-title color="blue-lighten-5">
                                <v-icon start>mdi-account-box-outline</v-icon>
                                患者情報・シチュエーション
                            </v-expansion-panel-title>
                            <v-expansion-panel-text>
                                <v-list density="compact">
                                    <v-list-item class="bg-green-lighten-5 rounded-lg mb-3 pa-3">
                                        <div class="font-weight-bold text-green-darken-4 mb-2">基本情報</div>
                                        <div><span class="text-grey-darken-1">氏名:</span> {{ patientInfo.name }}</div>
                                        <div><span class="text-grey-darken-1">年齢・性別:</span> {{ patientInfo.age }}歳 {{ patientInfo.gender }}</div>
                                        <div><span class="text-grey-darken-1">生年月日:</span> {{ patientInfo.birthDate }}</div>
                                        <div><span class="text-grey-darken-1">居住地:</span> {{ patientInfo.residence }}</div>
                                    </v-list-item>
                                    <!-- <v-list-item class="bg-purple-lighten-5 rounded-lg mb-3 pa-3">
                                        <div class="font-weight-bold text-purple-darken-4 mb-2">感染・発症</div>
                                        <div><span class="text-grey-darken-1">感染日:</span> {{ patientInfo.infectionDate }}</div>
                                        <div><span class="text-grey-darken-1">発症日:</span> {{ patientInfo.onsetDate }}</div>
                                    </v-list-item> -->
                                    <v-list-item class="bg-amber-lighten-5 rounded-lg pa-3">
                                        <div class="font-weight-bold text-amber-darken-4 mb-2">患者の特徴</div>
                                        <div class="text-caption text-grey-darken-3">{{ patientInfo.profile }}</div>
                                    </v-list-item>
                                </v-list>
                            </v-expansion-panel-text>
                        </v-expansion-panel>
                    </v-expansion-panels>
                </div>

                <!-- チャット画面 -->
                <div class="d-flex flex-column mt-4 chat-col" style="height: 100%;">
                    <v-card id="chat-card" rounded="lg" elevation="2" style="flex: 1 1 auto; height: 100%;">
                        <v-toolbar density="compact" color="grey-lighten-3">
                            <v-toolbar-title class="text-subtitle-1 font-weight-bold">
                                <v-icon start :color="userStatus === 'Established' ? 'green' : 'orange'">
                                    {{ userStatus === 'Established' ? 'mdi-circle' : 'mdi-circle-outline' }}
                                </v-icon>
                                {{ (patientInfo.name && roleNameDraft === '保健師') ? patientInfo.name : '患者' }}さん
                                <span v-if="patientInfo.id && roleNameDraft === '保健師'">
                                    （患者ID: <span class="font-weight-bold text-blue-darken-3">{{ patientInfo.id }}</span>）
                                </span>
                            </v-toolbar-title>
                        </v-toolbar>

                        <v-card-text id="chat-history-container">
                            <div v-for="(item, index) in chatHistory" :key="index" class="d-flex mb-2" :class="item.sender === 'interviewer' ? 'justify-end' : 'justify-start'">
                                <v-sheet max-width="70%" class="rounded-lg pa-3" :class="item.sender === 'interviewer' ? 'message-bubble-user' : 'message-bubble-patient'">
                                    <div class="d-flex align-start">
                                        <v-icon class="mr-2 mt-1">{{ item.sender === 'interviewer' ? 'mdi-account-tie-woman' : 'mdi-account' }}</v-icon>
                                        <div class="text-body-1" style="white-space: pre-wrap; word-break: break-all;">{{ item.message }}</div>
                                    </div>
                                </v-sheet>
                            </div>
                        </v-card-text>
                    </v-card>
                </div>
            </v-container>
        </v-main>

        <v-footer app class="pa-2 bg-grey-lighten-3">
            <v-textarea
                v-model="chatInputText"
                placeholder="150文字以内で入力してください"
                rows="1"
                auto-grow
                no-resize
                outlined
                dense
                hide-details
                class="mr-2"
                :disabled="chatInputDisabled"
                @keydown.enter="handleEnterKey"
            ></v-textarea>
            <v-btn icon="mdi-send" color="blue" @click="submitChatInputText" :disabled="!chatInputText.trim() || chatInputDisabled"></v-btn>
        </v-footer>

        <!-- ドロワー（設定メニュー） -->
        <v-navigation-drawer v-model="drawer" location="right" temporary width="360">
            <v-toolbar title="操作メニュー">
                <v-spacer></v-spacer>
                <v-btn icon="mdi-close" @click.stop="drawer = !drawer"></v-btn>
            </v-toolbar>
            <v-divider></v-divider>
            <v-list nav dense>
                <v-list-item title="ロール">
                    <v-dialog v-model="registrationDialog" persistent max-width="400px">
                        <template v-slot:activator="{ props: activatorProps }">
                            <v-btn density="default" block class="pa-2" :disabled="roleNameBtnDisabled" v-bind="activatorProps">
                                {{ roleNameText }}
                            </v-btn>
                        </template>
                        <v-card prepend-icon="mdi mdi-account-alert" title="ロールの選択" text="保健師か患者を選択してください。">
                            <template v-slot:actions>
                                <div class="w-100 pa-4">
                                    <v-text-field v-model="userName" label="お名前" required></v-text-field>
                                    <div class="d-flex flex-col justify-space-evenly">
                                        <v-radio-group v-model="roleNameDraft" class="flex-grow-0">
                                            <v-radio label="保健師" value="保健師"></v-radio>
                                            <v-radio label="患者" value="患者"></v-radio>
                                        </v-radio-group>
                                        <div v-if="roleNameDraft == '保健師'" class="flex-grow-5 h-auto d-flex align-center" style="width: 120px">
                                            <v-select v-model="patientId" label="患者ID" :items="patientIds"></v-select>
                                        </div>
                                        <div class="h-auto d-flex align-center">
                                            <v-btn class="pa-2 elevation-2" @click="submitRegistrationDialog">登録</v-btn>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </v-card>
                    </v-dialog>
                </v-list-item>
                <v-list-item id="submitEndOfSession" class="mt-2 mr-2" prepend-icon="mdi-file-document-check-outline" variant="outlined">
                    <v-btn @click="confirmEndSessionDialog = true">会話の終了</v-btn>
                </v-list-item>
                <v-divider thickness="2" color="block" class="my-3"></v-divider>
                <v-list-item title="文字の大きさ">
                    <v-slider v-model="chatHitsoryFontSizeNum" @end="changeFontSize" :ticks="{0:'小',1:'中',2:'大'}" min="0" max="2" step="1" show-ticks="always" tick-size="2"></v-slider>
                </v-list-item>
                <v-list-item>
                    <v-checkbox label="改行で送信" v-model="confSubmitWithEnter" density="compact" hide-details="true"></v-checkbox>
                </v-list-item>
                <v-list-item>
                    <v-checkbox label="送信後クリア" v-model="confSubmitThenClear" density="compact" hide-details="true"></v-checkbox>
                </v-list-item>
                <v-list-item title="会話の最後へ" prepend-icon="mdi-arrow-collapse-down" @click="closeAndChatHistoryToBottom"></v-list-item>
                <v-divider class="my-2"></v-divider>
                <v-list-item title="このページを印刷する" prepend-icon="mdi-printer" @click="printPage"></v-list-item>
            </v-list>
        </v-navigation-drawer>
        
        <!-- 会話終了確認ダイアログ -->
        <v-dialog v-model="confirmEndSessionDialog" max-width="400">
            <v-card title="会話を終了しますか？">
                <v-card-actions>
                    <v-spacer></v-spacer>
                    <v-btn @click="cancelEndSessionRequest">続ける</v-btn>
                    <v-btn color="error" @click="submitEndSessionRequest">終了する</v-btn>
                </v-card-actions>
            </v-card>
        </v-dialog>
    </v-app>
</div>

<script>
async function get_data(url, opt = {}) {
    opt.headers = { 'Content-Type': 'application/json', ...opt.headers };
    const res = await fetch(url, opt);
    if (!res.ok) {
        const errorText = await res.text();
        throw new Error(`HTTP error! status: ${res.status}, text: ${errorText}`);
    }
    return await res.json();
}

const { createApp } = Vue;
const { createVuetify } = Vuetify;
const vuetify = createVuetify();

const app = createApp({
    data() {
        return {
            // system
            drawer: false,
            ws: null,
            protocol: null,
            host: null,
            MessageToUser: 'ロールを選択してください。',
            // user
            userId: null,
            userName: '',
            userStatus: null,
            sessionId: null,
            // registration
            registrationDialog: true,
            roleNameBtnDisabled: false,
            roleNameText: 'ロール選択',
            roleNameDraft: null,
            patientIds: [],
            patientId: null,
            // patient info
            patientInfo: {},
            // chat
            chatHistory: [],
            chatInputText: '',
            chatInputDisabled: true,
            chatInputLock: false,
            chatHitsoryFontSizeNum: 1,
            confSubmitWithEnter: false,
            confSubmitThenClear: true,
            // dialogs
            confirmEndSessionDialog: false,
        };
    },
    computed: {
        statusColor() {
            if (this.userStatus === 'Established') return 'success';
            if (this.MessageToUser.includes('失敗') || this.MessageToUser.includes('エラー')) return 'error';
            return 'info';
        }
    },
    mounted() {
        const ret = /^(https?):\/\/([^/]+)/.exec(document.baseURI);
        if (ret) {
            this.protocol = ret[1];
            this.host = ret[2];
            this.fetchPatientIds();
        } else {
            console.error("URLの解析に失敗しました。");
            this.MessageToUser = "アプリケーションのURLの解析に失敗しました。";
        }
    },
    watch: {
        patientId(newId, oldId) {
            if (newId && newId !== oldId && this.roleNameDraft === '保健師') {
                this.fetchPatientDetails(newId);
            }
        }
    },
    methods: {
        handleEnterKey(e) {
            if (this.confSubmitWithEnter && !e.shiftKey) {
                e.preventDefault();
                this.submitChatInputText();
            } else if (e.ctrlKey) {
                this.submitChatInputText();
            }
        },
        async fetchPatientIds() {
            try {
                const url = `${this.protocol}://${this.host}/v1/patients`;
                const res = await get_data(url);
                this.patientIds = res.patient_ids ? res.patient_ids.map(String) : [];
            } catch (err) {
                console.error("患者IDリストの取得に失敗:", err);
                this.MessageToUser = "患者IDリストの取得に失敗しました。";
            }
        },
        async fetchPatientDetails(patientId) {
            try {
                const url = `${this.protocol}://${this.host}/v1/patient/${patientId}`;
                this.patientInfo = await get_data(url);
            } catch (err) {
                console.error("患者情報の取得に失敗:", err);
                this.MessageToUser = `患者情報(ID: ${patientId})の取得に失敗しました。`;
                this.patientInfo = {};
            }
        },
        sessionInitialized() {
            this.userId = null;
            this.userStatus = null;
            this.sessionId = null;
            this.roleNameText = 'ロール選択';
            this.roleNameDraft = null;
            this.chatHistory = [];
            this.patientInfo = {};
            this.patientId = null;
            this.registrationDialog = true;
            this.roleNameBtnDisabled = false;
            this.chatInputDisabled = true;
        },
        sessionClosed() {
            this.MessageToUser = '接続が切れました。再度ロールを選択してください。';
            if (this.ws) {
                this.ws.onclose = null;
                this.ws.close();
            }
            this.ws = null;
            this.sessionInitialized();
        },
        submitRegistrationDialog() {
            if (!this.userName.trim()) {
                this.MessageToUser = "お名前を入力してください。";
                return;
            }
            if (!this.roleNameDraft) {
                this.MessageToUser = "ロールを選択してください。";
                return;
            }
            if (this.roleNameDraft === '保健師' && !this.patientId) {
                this.MessageToUser = "保健師の場合は患者IDを選択してください。";
                return;
            }
            
            this.roleNameText = this.roleNameDraft;
            this.roleNameBtnDisabled = true;
            this.registrationDialog = false;
            this.startWebSocket();
        },
        startWebSocket() {
            const body = {
                msg_type: 'RegistrationRequest',
                user_name: this.userName,
                user_role: this.roleNameDraft,
                target_patient_id: this.roleNameDraft === '保健師' ? String(this.patientId) : null,
            };
            const url = `${this.protocol}://${this.host}/v1`;
            get_data(url, { method: 'POST', body: JSON.stringify(body) })
                .then(res => {
                    this.userId = res.user_id;
                    this.sessionId = res.session_id;
                    this.userStatus = res.user_status;
                    if (res.msg_type === 'RegistrationAccepted') {
                        this.MessageToUser = '登録完了。相手を待っています...';
                        this.connectWebSocket();
                    } else {
                        this.MessageToUser = '登録に失敗しました。';
                    }
                })
                .catch(err => {
                    console.error("登録エラー:", err);
                    this.MessageToUser = "登録リクエストに失敗しました。";
                    this.roleNameBtnDisabled = false;
                });
        },
        connectWebSocket() {
            const wsProtocol = this.protocol === 'https' ? 'wss' : 'ws';
            const url = `${wsProtocol}://${this.host}/v1/ws/${this.userId}`;
            this.ws = new WebSocket(url);

            this.ws.onmessage = (event) => {
                const ret = JSON.parse(event.data);
                console.log("WS Received:", ret);
                switch (ret.msg_type) {
                    case 'Prepared':
                        this.MessageToUser = '相手を探しています...';
                        break;
                    case 'Established':
                        this.sessionId = ret.session_id;
                        this.userStatus = 'Established';
                        this.MessageToUser = '接続完了。チャットを開始できます。';
                        this.chatInputDisabled = false;
                        break;
                    case 'MessageForwarded':
                        this.chatHistory.push({
                            sender: 'patient',
                            message: ret.user_msg,
                        });
                        this.chatInputLock = false;
                        this.scrollToBottom();
                        break;
                    case 'SessionTerminated':
                        this.MessageToUser = 'セッションが終了しました。';
                        this.sessionClosed();
                        break;
                }
            };
            this.ws.onclose = () => this.sessionClosed();
            this.ws.onerror = (err) => {
                console.error("WebSocketエラー:", err);
                this.MessageToUser = "WebSocket接続でエラーが発生しました。";
                this.sessionClosed();
            };
        },
        submitChatInputText() {
            const text = this.chatInputText.trim();
            if (!text || this.chatInputLock || this.userStatus !== 'Established') return;

            this.chatInputLock = true;
            this.chatHistory.push({
                sender: 'interviewer',
                message: text,
            });
            this.scrollToBottom();

            this.ws.send(JSON.stringify({
                msg_type: 'MessageSubmitted',
                session_id: this.sessionId,
                user_id: this.userId,
                user_msg: text,
            }));
            if (this.confSubmitThenClear) {
                this.chatInputText = '';
            }
        },
        cancelEndSessionRequest() {
            this.confirmEndSessionDialog = false;
        },
        submitEndSessionRequest() {
            this.confirmEndSessionDialog = false;
            if (this.ws && this.sessionId) {
                this.ws.send(JSON.stringify({
                    msg_type: 'EndSessionRequest',
                    session_id: this.sessionId,
                    user_id: this.userId,
                }));
            }
        },
        async scrollToBottom() {
            await this.$nextTick();
            const mainContent = document.querySelector('.v-main');
            if (mainContent) {
                mainContent.scrollTop = mainContent.scrollHeight;
            }
        },
        closeAndChatHistoryToBottom() {
            this.drawer = false;
            this.scrollToBottom();
        },
        changeFontSize(value) {
            if (value == 0) {
                this.chatHistoryFontSize = 'text-h6';
            } else if (value == 1) {
                this.chatHistoryFontSize = 'text-h5';
            } else if (value == 2) {
                this.chatHistoryFontSize = 'text-h4';
            }
            this.chatHistoryToBottom();
        },
        printPage() {
            this.drawer = false;
            this.$nextTick(() => {
                setTimeout(() => {
                    window.print();
                }, 200);
            });
        },
    },
});
app.use(vuetify).mount('#app');
</script>
</body>
</html>
